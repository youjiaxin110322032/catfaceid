<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cat Face ID — Multi Cat</title>
  <link rel="stylesheet" href="normalize.css">
  <link rel="stylesheet" href="style.css">



<style>
 .backdrop {
  display: flex;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center; align-items: center;
  z-index: 10000;
}

.modal {
  background: #e6dfba;
  border-radius: 8px;
  padding: 20px;
  width: 450px;
  max-width: 90%;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  position: relative;
  font-family: 'Microsoft JhengHei', sans-serif;
  color: #5f4f00;
}

.modalClose {
  position: absolute;
  top: 12px; right: 12px;
  cursor: pointer;
  width: 24px;
  filter: invert(30%) sepia(70%) saturate(300%) hue-rotate(20deg) brightness(0.8);
}


.catresume {
  display: flex;
  gap: 20px;
  margin-bottom: 15px;
}

.catresume img {
  width: 120px;
  height: 140px;
  border-radius: 6px;
  object-fit: cover;
  border: 2px solid #7a6c00;
}

.catresume div {
  flex: 1;
}

.modalNames {
  background: #b0a653;
  border-radius: 4px;
  font-weight: 700;
  font-size: 24px;
  text-align: center;
  padding: 6px 0;
  margin-bottom: 8px;
  color: #3f3a00;
  user-select: none;
}

.catresume p {
  font-size: 14px;
  line-height: 1.4;
  white-space: pre-line; /* 支持換行 */
}

.comment-box {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: center;
}

.comment-box input[type="text"] {
  flex-grow: 1;
  padding: 8px 12px;
  border-radius: 16px;
  border: 1px solid #b0a653;
  font-size: 14px;
  outline: none;
}

.comment-box button {
  background: #7a6c00;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 16px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.comment-box button:hover {
  background: #a3982f;
}

.comment-list {
  margin-top: 15px;
  max-height: 160px;
  overflow-y: auto;
  font-size: 14px;
  border-top: 1px solid #b0a653;
  padding-top: 10px;
}
.comment {
  padding: 4px 6px;
  border-bottom: 1px solid #d4cc87;
}
</style>





</head>
<body>
  <header>
    <h1>喵喵株式會社</h1>
    <nav>
      <p><a href="aboutus.html">關於我們</a></p>
      <p><a href="index.html">員工辨識</a></p>
      <p><a href="aboutsystem.html">系統介紹</a></p>
    </nav>
  </header>

  <div class="wrap">
    <h1>員工辨識</h1>
    <div class="cam-box">
      <video id="preview" playsinline autoplay muted></video>
      <canvas id="overlay" class="overlay"></canvas>
    </div>
    <div class="btns">
      <button id="btnStart" type="button">啟動相機</button>
      <button id="btnShot" type="button">進行辨識</button>
    </div>
    <div class="foot">
      <div class="msg" id="status">狀態：待機</div>
      <div class="api hidden">API：<span id="api-url" class="small"></span></div>
      <div class="known hidden">已知貓：<span id="knownCats" class="small">載入中…</span></div>
    </div>
  </div>

  <img id="cat-cursor" src="more_img/cat_hand.png" alt="cat paw">

  <script>
const API_URL = 'http://127.0.0.1:8000/predict';
document.getElementById('api-url').textContent = API_URL;

const video = document.getElementById('preview');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const btnShot  = document.getElementById('btnShot');
const knownCats = document.getElementById('knownCats');

let currentStream = null;
let toJpegQuality = 0.9;

function setStatus(s){ statusEl.textContent = '狀態：' + s; }
function clearOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); }

function resizeOverlay() {
  const rect = video.getBoundingClientRect();
  overlay.width = rect.width * devicePixelRatio;
  overlay.height = rect.height * devicePixelRatio;
  overlay.style.width = rect.width + 'px';
  overlay.style.height = rect.height + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  clearOverlay();
}
window.addEventListener('resize', resizeOverlay);

// 啟動相機
async function startCamera() {
  try {
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    await video.play();
    currentStream = stream;
    resizeOverlay();
    setStatus('相機啟動成功');
  } catch(e) {
    console.error(e);
    setStatus('相機啟動失敗');
    alert('相機啟動失敗');
  }
}

// 擷取影格
async function grabVideoFrameBlob() {
  if (!video.videoWidth) return null;
  const tmp = document.createElement('canvas');
  tmp.width = video.videoWidth; tmp.height = video.videoHeight;
  tmp.getContext('2d').drawImage(video, 0, 0, tmp.width, tmp.height);
  return await new Promise(res => tmp.toBlob(res, 'image/jpeg', toJpegQuality));
}

// 呼叫 API
async function sendToAPI(imageBlob){
  const fd = new FormData();
  fd.append('file', imageBlob, 'shot.jpg');
  const r = await fetch(API_URL, { method: 'POST', body: fd });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

const catImages = {
  mama: 'more_img/mama_headshot.png',
  coco: 'more_img/coco_headshot.png',
  jojo: 'more_img/jojo_headshot.png'
};


// 建立 modal（每隻貓一個，獨立存在）
function createCatModal(catName, imgUrl = null) {
  // ✅ 每次建立新的 backdrop，確保獨立
  const backdrop = document.createElement('div');
  backdrop.className = 'backdrop';
  backdrop.dataset.cat = catName; // 給每隻貓一個識別屬性
  backdrop.style.zIndex = 1000 + document.querySelectorAll('.backdrop').length;

  // ✅ 獨立 modal HTML
  backdrop.innerHTML = `
    <div class="modal">
      <img class="modalClose" src="more_img/close.png" alt="關閉" 
           style="position:absolute;top:10px;right:10px;width:24px;cursor:pointer;">
      <div class="catresume">
        <img src="${imgUrl || catImages[catName] || 'more_img/unknown_cat.png'}"
             style="width:80px;height:80px;border-radius:50%;">
        <div>
          <div class="modalNames">
            <span class="chip">${catName}</span>
          </div>
          <div class="comment-box">
            <input type="text" class="commentInput" placeholder="匿名留言..." />
            <button class="commentBtn">發布</button>
          </div>
          <div class="comment-list"></div>
        </div>
      </div>
    </div>
  `;

  // ✅ 加進 DOM，不會覆蓋別的貓
  document.body.appendChild(backdrop);

  // ✅ 關閉功能
  const closeBtn = backdrop.querySelector('.modalClose');
  closeBtn.addEventListener('click', () => backdrop.remove());
  backdrop.addEventListener('click', e => {
    if (e.target === backdrop) backdrop.remove();
  });

  const commentInput = backdrop.querySelector('.commentInput');
  const commentBtn = backdrop.querySelector('.commentBtn');
  const commentList = backdrop.querySelector('.comment-list');

  // ✅ 載入留言
  async function loadComments() {
    try {
      const res = await fetch(`${API_URL.replace('/predict','/comments')}?cat_name=${catName}`);
      const data = await res.json();
      renderComments(data.comments || []);
    } catch {
      renderComments([]);
    }
  }

  function renderComments(comments) {
    commentList.innerHTML = comments.map(c => `<div class="comment">${c}</div>`).join('');
  }

  // ✅ 發布留言
  commentBtn.addEventListener('click', async () => {
    const text = commentInput.value.trim();
    if (!text) return;
    try {
      const res = await fetch(`${API_URL.replace('/predict','/comment')}?cat_name=${catName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      renderComments(data.comments);
      commentInput.value = '';
    } catch (e) {
      alert('留言失敗：' + e.message);
    }
  });

  loadComments();
}




// 截圖 & 辨識
async function captureAndSend() {
  if (!video.videoWidth) return;
  setStatus('擷取畫面中…');
  try {
    const blob = await grabVideoFrameBlob();
    if (!blob) return;
    setStatus('上傳辨識中…');
    const data = await sendToAPI(blob);

    const boxes = data.boxes || [];
    if (!boxes.length) {
      setStatus('沒有偵測到貓臉');
      return;
    }

    for (let i = 0; i < boxes.length; i++) {
      const b = boxes[i];
      const catKey = b.name === 'Unknown' ? `Unknown_${i+1}` : b.name;
      createCatModal(catKey, b.imgUrl || null);
      await new Promise(res => setTimeout(res, 200));
    }
    setStatus('完成');
  } catch(e) {
    console.error(e);
    alert('辨識失敗：' + e.message);
    setStatus('辨識失敗');
  }
}

// 事件綁定
btnStart.addEventListener('click', startCamera);
btnShot.addEventListener('click', captureAndSend);

// 游標效果
const catCursor = document.getElementById('cat-cursor');
document.addEventListener('mousemove', e => {
  catCursor.style.left = `${e.clientX}px`;
  catCursor.style.top = `${e.clientY}px`;
});
document.addEventListener('click', e => {
  catCursor.style.transform = 'scale(0.8)';
  setTimeout(()=>catCursor.style.transform='scale(1)',100);
});

// 載入已知貓
(async () => {
  try {
    const labelsURL = API_URL.replace('/predict','/labels');
    const r = await fetch(labelsURL);
    const j = await r.json();
    knownCats.textContent = (j.labels || []).join('、') || '（無）';
  } catch {
    knownCats.textContent = '無法取得';
  }
})();
  </script>
</body>
</html>
